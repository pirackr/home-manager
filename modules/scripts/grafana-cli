#!/usr/bin/env -S uv run --script --quiet
# /// script
# dependencies = ["click", "python-dotenv", "requests"]
# ///
"""
grafana-cli - Query Grafana dashboards from command line.

Config: Set GRAFANA_HOST, GRAFANA_USERNAME, GRAFANA_PASSWORD, GRAFANA_ORG_ID env vars
        or put them in .env file.
"""
import json
import os
import sys
from pathlib import Path
from urllib.parse import urljoin, urlparse, parse_qs

import click
import requests
from dotenv import load_dotenv


def load_config():
    """Load configuration from environment variables."""
    env_locations = [
        Path.cwd() / '.env',
        Path.home() / '.grafana-cli' / '.env',
    ]
    for env_path in env_locations:
        if env_path.exists():
            load_dotenv(env_path)
            break

    return {
        'host': os.getenv('GRAFANA_HOST', ''),
        'username': os.getenv('GRAFANA_USERNAME'),
        'password': os.getenv('GRAFANA_PASSWORD'),
        'org_id': int(os.getenv('GRAFANA_ORG_ID', '1')),
    }


def require_credentials(config):
    """Verify credentials are set, exit if not."""
    if not config['username'] or not config['password']:
        click.echo("Error: GRAFANA_USERNAME and GRAFANA_PASSWORD must be set.", err=True)
        click.echo("Set them in .env file or as environment variables.", err=True)
        sys.exit(1)


class GrafanaClient:
    """Client for querying Grafana dashboards."""

    def __init__(self, host, username, password, org_id=1):
        self.host = host.rstrip('/')
        if not self.host.startswith('http'):
            self.host = f"https://{self.host}"
        self.session = requests.Session()
        self.session.auth = (username, password)
        self.session.headers.update({
            'Content-Type': 'application/json',
            'Accept': 'application/json',
        })
        self.org_id = org_id

    def _api_url(self, endpoint):
        return urljoin(self.host, f"/api/{endpoint.lstrip('/')}")

    def test_connection(self):
        try:
            resp = self.session.get(self._api_url('/org'), timeout=10)
            if resp.status_code == 200:
                org = resp.json()
                return True, f"Connected to org: {org.get('name', 'unknown')}"
            elif resp.status_code == 401:
                return False, "Authentication failed - check username/password"
            else:
                return False, f"HTTP {resp.status_code}: {resp.text}"
        except requests.exceptions.SSLError as e:
            return False, f"SSL Error: {e}"
        except requests.exceptions.ConnectionError as e:
            return False, f"Connection Error: {e}"
        except Exception as e:
            return False, str(e)

    def get_dashboard(self, uid):
        resp = self.session.get(self._api_url(f'/dashboards/uid/{uid}'), timeout=30)
        resp.raise_for_status()
        return resp.json()

    def list_panels(self, dashboard_uid):
        dashboard_data = self.get_dashboard(dashboard_uid)
        dashboard = dashboard_data.get('dashboard', {})
        panels = []
        for p in dashboard.get('panels', []):
            panels.append({
                'id': p.get('id'),
                'title': p.get('title', 'Untitled'),
                'type': p.get('type', 'unknown'),
            })
            for nested in p.get('panels', []):
                panels.append({
                    'id': nested.get('id'),
                    'title': nested.get('title', 'Untitled'),
                    'type': nested.get('type', 'unknown'),
                    'parent': p.get('title'),
                })
        return panels

    def query_panel(self, dashboard_uid, panel_id, from_time, to_time, variables=None):
        dashboard_data = self.get_dashboard(dashboard_uid)
        dashboard = dashboard_data.get('dashboard', {})

        panel = None
        for p in dashboard.get('panels', []):
            if p.get('id') == panel_id:
                panel = p
                break
            for nested in p.get('panels', []):
                if nested.get('id') == panel_id:
                    panel = nested
                    break

        if not panel:
            raise ValueError(f"Panel {panel_id} not found in dashboard")

        targets = panel.get('targets', [])
        if not targets:
            raise ValueError(f"Panel {panel_id} has no queries")

        queries = []
        for target in targets:
            query = {
                'refId': target.get('refId', 'A'),
                'expr': target.get('expr', ''),
                'datasource': target.get('datasource', panel.get('datasource')),
            }
            if variables:
                for var_name, var_value in variables.items():
                    var_key = var_name.replace('var-', '$')
                    query['expr'] = query['expr'].replace(var_key, var_value)
            queries.append(query)

        payload = {'queries': queries, 'from': from_time, 'to': to_time}
        resp = self.session.post(self._api_url('/ds/query'), json=payload, timeout=60)
        resp.raise_for_status()
        return resp.json()

    def get_datasource_by_name(self, name):
        resp = self.session.get(self._api_url('/datasources'), timeout=30)
        resp.raise_for_status()
        for ds in resp.json():
            if ds.get('name') == name:
                return ds
        return None

    def query_prometheus(self, datasource_name, query):
        datasource = self.get_datasource_by_name(datasource_name)
        if not datasource:
            raise ValueError(f"Datasource '{datasource_name}' not found")
        ds_id = datasource['id']
        resp = self.session.get(
            self._api_url(f'/datasources/proxy/{ds_id}/api/v1/query'),
            params={'query': query},
            timeout=60,
        )
        resp.raise_for_status()
        return resp.json()

    def check_argocd_health(self, datasource_name, cluster='', namespace='', spoke='', name_filter=''):
        labels = []
        if cluster:
            labels.append(f'axon_cluster="{cluster}"')
        if namespace:
            labels.append(f'dest_namespace="{namespace}"')
        if spoke:
            labels.append(f'spoke="{spoke}"')
        if name_filter:
            labels.append(f'name=~".*{name_filter}.*"')

        label_selector = ','.join(labels)
        query = f'argocd_app_info{{{label_selector}}}'

        result = self.query_prometheus(datasource_name, query)
        services = []
        for r in result.get('data', {}).get('result', []):
            metric = r.get('metric', {})
            services.append({
                'name': metric.get('name', 'unknown'),
                'health_status': metric.get('health_status', 'unknown'),
                'sync_status': metric.get('sync_status', 'unknown'),
                'namespace': metric.get('dest_namespace', 'unknown'),
                'cluster': metric.get('axon_cluster', 'unknown'),
                'spoke': metric.get('spoke', 'unknown'),
            })
        return services


def parse_dashboard_url(url):
    """Parse a Grafana dashboard URL to extract parameters."""
    parsed = urlparse(url)
    path_parts = parsed.path.split('/')
    uid = None
    for i, part in enumerate(path_parts):
        if part == 'd' and i + 1 < len(path_parts):
            uid = path_parts[i + 1]
            break

    params = parse_qs(parsed.query)
    variables = {}
    for key, values in params.items():
        if key.startswith('var-'):
            variables[key] = values[0] if values else ''

    return {
        'host': f"{parsed.scheme}://{parsed.netloc}",
        'uid': uid,
        'variables': variables,
        'from': params.get('from', ['now-3h'])[0],
        'to': params.get('to', ['now'])[0],
        'orgId': params.get('orgId', ['1'])[0],
    }


def get_client(config, host_override=None):
    """Create a Grafana client."""
    require_credentials(config)
    host = host_override or config['host']
    if not host:
        click.echo("Error: GRAFANA_HOST must be set or provided via --host or URL.", err=True)
        sys.exit(1)
    return GrafanaClient(
        host=host,
        username=config['username'],
        password=config['password'],
        org_id=config['org_id'],
    )


@click.group()
@click.version_option(version='1.0.0')
def cli():
    """Grafana Query CLI - Query Grafana dashboards from command line."""
    pass


@cli.command()
@click.option('--host', '-h', help='Grafana host URL (overrides GRAFANA_HOST)')
def test_connection(host):
    """Test connection to Grafana.

    Example:
        grafana-cli test-connection
        grafana-cli test-connection --host https://grafana.example.com
    """
    config = load_config()
    host = host or config['host']
    if not host:
        click.echo("Error: GRAFANA_HOST must be set or provided via --host.", err=True)
        sys.exit(1)
    require_credentials(config)

    click.echo(f"Testing connection to {host}...")
    client = GrafanaClient(
        host=host,
        username=config['username'],
        password=config['password'],
        org_id=config['org_id'],
    )
    success, message = client.test_connection()
    if success:
        click.echo(f"Connection successful! {message}")
    else:
        click.echo("Connection failed!", err=True)
        click.echo(f"Error: {message}", err=True)
        sys.exit(1)


@cli.command()
@click.argument('url')
@click.option('--panel', '-p', help='Panel title or ID to query (partial match supported)')
@click.option('--json-output', is_flag=True, help='Output as JSON')
def query_url(url, panel, json_output):
    """Query a Grafana dashboard from its URL.

    Lists panels if no --panel specified, or queries the specified panel.

    Example:
        grafana-cli query-url "https://grafana.example.com/d/abc/dash?var-cluster=prod"
        grafana-cli query-url "https://..." --panel "Deployment Status" --json-output
    """
    config = load_config()
    params = parse_dashboard_url(url)

    if not params['uid']:
        click.echo("Error: Could not extract dashboard UID from URL", err=True)
        sys.exit(1)

    client = get_client(config, params['host'])

    try:
        panels = client.list_panels(params['uid'])

        if not panel:
            click.echo("Available panels:")
            for p in panels:
                click.echo(f"  [{p['id']}] {p['title']}")
            click.echo("\nUse --panel to query a specific panel")
            return

        # Find matching panel
        target_panel = None
        panel_lower = panel.lower()
        for p in panels:
            if str(p['id']) == panel or panel_lower in p['title'].lower():
                target_panel = p
                break

        if not target_panel:
            click.echo(f"Error: Panel '{panel}' not found", err=True)
            click.echo("Available panels:")
            for p in panels:
                click.echo(f"  [{p['id']}] {p['title']}")
            sys.exit(1)

        click.echo(f"Querying panel: {target_panel['title']} (ID: {target_panel['id']})")
        click.echo(f"Variables: {params['variables']}")

        result = client.query_panel(
            dashboard_uid=params['uid'],
            panel_id=target_panel['id'],
            from_time=params['from'],
            to_time=params['to'],
            variables=params['variables'],
        )

        if json_output:
            click.echo(json.dumps(result, indent=2))
        else:
            display_query_results(result)

    except Exception as e:
        click.echo(f"Error: {e}", err=True)
        sys.exit(1)


@cli.command()
@click.argument('datasource')
@click.option('--cluster', '-c', default='', help='Filter by cluster name')
@click.option('--namespace', '-n', default='', help='Filter by namespace')
@click.option('--spoke', '-s', default='', help='Filter by spoke')
@click.option('--filter', '-f', default='', help='Filter by app name pattern')
@click.option('--host', '-h', help='Grafana host URL')
@click.option('--json-output', is_flag=True, help='Output as JSON')
def check_argocd(datasource, cluster, namespace, spoke, filter, host, json_output):
    """Check ArgoCD application health status via Prometheus metrics.

    DATASOURCE is the Prometheus/Cortex datasource name (e.g., cortex-us4).

    Example:
        grafana-cli check-argocd cortex-us4 --cluster dems --namespace ais-transition --filter taurus
    """
    config = load_config()
    client = get_client(config, host)

    try:
        services = client.check_argocd_health(
            datasource_name=datasource,
            cluster=cluster,
            namespace=namespace,
            spoke=spoke,
            name_filter=filter,
        )

        if json_output:
            click.echo(json.dumps(services, indent=2))
            return

        if not services:
            click.echo("No services found matching the criteria")
            return

        click.echo(f"Found {len(services)} services:\n")

        all_healthy = True
        for svc in services:
            health = svc.get('health_status', 'Unknown')
            sync = svc.get('sync_status', 'Unknown')
            icon = 'OK' if health == 'Healthy' else 'FAIL'
            if health != 'Healthy':
                all_healthy = False
            click.echo(f"  [{icon}] {svc['name']:40s} health={health:10s} sync={sync:10s} ns={svc['namespace']}")

        click.echo("")
        if all_healthy:
            click.echo("All services are HEALTHY")
        else:
            click.echo("Some services are NOT healthy")
            sys.exit(1)

    except Exception as e:
        click.echo(f"Error: {e}", err=True)
        sys.exit(1)


def display_query_results(result):
    """Display query results in a readable format."""
    results = result.get('results', {})
    for ref_id, data in results.items():
        frames = data.get('frames', [])
        for frame in frames:
            schema = frame.get('schema', {})
            fields = schema.get('fields', [])
            data_values = frame.get('data', {}).get('values', [])

            if not fields or not data_values:
                continue

            headers = [f.get('name', f'Col{i}') for i, f in enumerate(fields)]
            rows = list(zip(*data_values)) if data_values else []

            if rows:
                click.echo('  '.join(headers))
                click.echo('-' * (sum(len(h) + 2 for h in headers)))
                for row in rows[:50]:
                    click.echo('  '.join(str(v)[:50] for v in row))
                if len(rows) > 50:
                    click.echo(f"... showing 50 of {len(rows)} rows")
            else:
                click.echo("No results")


if __name__ == '__main__':
    cli()
